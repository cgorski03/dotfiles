TARGET_WINDOW_INDEX="$1"
SESSION_ID=$(tmux display-message -p '#{session_id}')

# Use tmux list-windows to get a reliable list of existing window indices
# and check if our target index is among them.
# The -F option formats the output, -f filters.
# This checks if a window with the exact numerical index exists.
# We also check if that index is not "dead" (closed but index preserved)
# (window_active is 0 for non-active, 1 for active; just need it to exist)
if tmux list-windows -F "#{window_index}" | grep -q "^${TARGET_WINDOW_INDEX}$"; then
    # Window with this index exists, select it
    echo "DEBUG: Window $TARGET_WINDOW_INDEX exists. Attempting to select..." >&2
    tmux select-window -t "$SESSION_ID:$TARGET_WINDOW_INDEX"
    if [ $? -ne 0 ]; then
        echo "ERROR: Failed to select existing window $TARGET_WINDOW_INDEX." >&2
    fi
else
    # Window does not exist, so create it and then select it
    echo "DEBUG: Window $TARGET_WINDOW_INDEX does not exist. Attempting to create and select." >&2
    # new-window will usually find the first available index if -t isn't used,
    # but since we want a specific index, we use -t.
    # If the index is taken, new-window will shift other windows.
    # The -d flag means "don't switch to it immediately"
    tmux new-window -d -t "$SESSION_ID:$TARGET_WINDOW_INDEX" && \
    tmux select-window -t "$SESSION_ID:$TARGET_WINDOW_INDEX"
    if [ $? -ne 0 ]; then
        echo "ERROR: Failed to create or select new window $TARGET_WINDOW_INDEX." >&2
    fi
fi
